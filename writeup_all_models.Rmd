---
title: "Technology growth time series modeling"
author: "Jim Savage"
date: "25 August 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This contains outputs from Jim's modeling of the technology time series
work with Jeff. The models we try are: 

1. Random walk moving average model, estimated without pooling for all technologies. 
2. Random walk moving average model, estimated with partial pooling across all technologies
3. Auto-regressive moving average model AR(1) and AR(2), estimated without pooling
4. Auto-regressive moving average model AR(1) and AR(2), estimated _with_ partial pooling
5. Time- intercept AR(1) model with partial pooling

# Data preparation

The data used are 66 time-series of technological productivity levels. We take the log levels of 
the productivity levels as the time-series. 

```{r}
library(readr); library(dplyr); library(ggplot2); library(reshape2)
fl_data <- read_csv("Farmer_Lafond_Data_2.csv")

fl_long <- fl_data %>% 
  melt(id = "YEAR") %>%
  filter(!is.na(value)) %>%
  mutate(technology_l = log(value),
         technology = as.numeric(as.factor(variable))) %>%
  group_by(variable) %>%
  mutate(time = 1:n())

```



```{r, cache = T}
library(rstan); library(loo)

compiled_arma = stan_model("vetted_models/arma_1.stan")

out <- data_frame(technology = unique(fl_long$variable) %>% as.character, 
                  mu = NA, K = NA, sigma = NA, elpd = NA)
for(i in 1:nrow(out)) {
  tmp <- fl_long %>% 
    filter(variable ==out[i,1][[1]])
  
  mod <- sampling(compiled_arma, data = list(T = nrow(tmp), y = tmp$technology_l))
  
  par_ev <- as.data.frame(mod) %>% apply(2, mean)
  
  out[i, 2] = par_ev["mu"]
  out[i, 3] = par_ev["K"]
  out[i, 4] = par_ev["sigma"]
  ll <- extract_log_lik(mod, "lpd")
  loomod <- loo(ll)
  out[i, 5] = loomod$elpd_loo

}
```


